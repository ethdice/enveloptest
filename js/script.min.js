function loading(){$("body").hasClass("chat")||$(".toast").html(M.lang[M.curLang].other.shareImg).show()}var M={walletAddr:"",contracts:{},path:"https://blockchain.ijinshan.com/redpacket",isLoadingRecord:!1,record:null,timerToast:null,curLang:"en",lang:{},iosNet:!1,myInfoc:null,userInfo:null,isInDapp:function(){try{return 1==RedEnvelopeHost.isInDappAndroid()}catch(e){}},isInIosDapp:function(){return navigator.userAgent.indexOf("inIosDapp")>-1},iosNetStatus:function(e){M.iosNet=e},iosWalletAddress:function(e){M.walletAddr=e},getWalletAddr:function(){M.isInDapp()?(M.walletAddr=RedEnvelopeHost.getWalletAddress(),$("html").addClass("android")):M.isInIosDapp()&&($("body").hasClass("index")?window.webkit.messageHandlers.h5Callback.postMessage({indexName:"address"}):window.webkit.messageHandlers.sofaWalletAddress.postMessage({indexName:"address"}),$("html").addClass("ios"))},getInfoc:function(){var e=navigator.userAgent,a=e.split("$&*")[1];void 0!=a&&(a=a.split(";")[0].replace(/:/g,"=").replace(/\//g,"&")),a="?"+a;var t={ver:M.getParameter("ver",a),mcc:M.getParameter("mcc",a),cn:M.getParameter("cn",a),xaid:M.getParameter("xaid",a),osver:M.getParameter("osver",a),mnc:0,cl:navigator.language||navigator.browserLanguage,cn2:"",loc_time:1,brand:"",model:"",romver:"",adid:"",apilevel:23};return new Infoc("https://helpdappstore1.ksmobile.com",t)},getIosUserInfo:function(){try{var e={type:"SJbridge",functionName:"currentUserInfo"};M.userInfo=prompt(JSON.stringify(e))}catch(e){}},getUserId:function(){return M.isInDapp()?RedEnvelopeHost.getUserId():M.isInIosDapp()?M.userInfo.userid:""},getUserName:function(){return M.isInDapp()?RedEnvelopeHost.getUserName():M.isInIosDapp()?M.userInfo.name:""},getAvatar:function(){return M.isInDapp()?RedEnvelopeHost.getAvatarUrl():M.isInIosDapp()?M.userInfo.avatar:""},getEnvelopWord:function(){return M.isInDapp()?RedEnvelopeHost.getRedPacketPwd():(M.isInIosDapp(),"")},isDownload:function(){if(!M.isInDapp()&&!M.isInIosDapp()){var e='<div class="dialog"><div class="title">'+M.lang[M.curLang].other.downloadTitle+'</div><div class="cnt">'+M.lang[M.curLang].other.downloadCnt+'</div><a href="https://www.cmcmbc.com/zh-cn/dapp-browser/" class="d-btn btn-ok">'+M.lang[M.curLang].other.btnOk+'</a><a href="javascript:void(0);" class="d-btn btn-cancel">'+M.lang[M.curLang].other.btnCancel+"</a></div>";$("body").append(e),M.myInfoc.report({page:7,dappstore_red_packet_page_im:132})}},jumpUrl:function(e){if(M.isInDapp())if(e.indexOf("back")>-1)RedEnvelopeHost.onBackToRedEnvelope();else{if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);RedEnvelopeHost.jumpToEnvelope(e)}else if(M.isInIosDapp())if("back"==e)window.webkit.messageHandlers.sofaH5Callback.postMessage({indexName:e});else{if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);window.webkit.messageHandlers.h5Callback.postMessage({indexName:e})}},shareImg:function(e){if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);M.isInDapp()?""!=e?RedEnvelopeHost.createEnvelopeShare(JSON.stringify(e)):RedEnvelopeHost.createEnvelopeShare(""):M.isInIosDapp()&&(""!=e?window.webkit.messageHandlers.shareHongbao.postMessage({hongbaoCount:e.count,ethCount:e.money,word:e.word,invalidTime:e.time}):window.webkit.messageHandlers.h5Callback.postMessage({indexName:"share"}))},getEvelopSource:function(){try{if(M.isInDapp())return RedEnvelopeHost.getRedPacketSource();if(!M.isInIosDapp())return 0;try{var e={type:"SJbridge",functionName:"getRedPacketSource"};return prompt(JSON.stringify(e)).fromIndex}catch(e){}}catch(e){}},iosPhoneLanguage:function(e){M.curLang=e},getLang:function(){return M.isInDapp()?RedEnvelopeHost.getMobileLanguage():M.isInIosDapp()?M.curLang:"zh"},isHasNetwork:function(){return M.isInDapp()?RedEnvelopeHost.isMobileNetAvailable():!M.isInIosDapp()||M.iosNet},encodeParam:function(e){if(M.isInDapp())return RedEnvelopeHost.encryptBody(e);if(M.isInIosDapp())try{var a={type:"SJbridge",functionName:"AESEncode",data:e};return prompt(JSON.stringify(a))}catch(e){}return e},bind:function(){function e(e,a,t){""!=e&&(M.showToast(e),$(".btn").addClass("disabled")),a?(t.addClass("error"),t.parent().addClass("error")):(t.removeClass("error"),t.parent().removeClass("error"))}function a(e){e?$(".btn").addClass("disabled"):0==$("input.error").length&&0==$("textarea.error").length&&$(".btn").removeClass("disabled")}$("html").on("click",".dialog .btn-cancel",function(){$(".dialog").hide()}),$("body").on("click",".btn-ok",function(){}),$(".btn-send").click(function(){M.isDownload(),M.jumpUrl("send.html")}),$(".btn-snatch").click(function(){M.isDownload(),M.jumpUrl("snatch.html")}),$(".tip-record").click(function(){M.isDownload(),M.jumpUrl("record.html")}),$(".btn-generate").click(function(){M.isDownload(),M.shareImg("")}),$(".btn-return").click(function(){M.jumpUrl("back")}),$(".btn-confirm-pw").click(function(){var e=$(this);if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);e.hasClass("disabled")||(e.addClass("disabled"),$("textarea[name=command]").val().length<6?($("#iptCommand").addClass("hasClicked error"),M.showToast(M.lang[M.curLang].send.msg6)):""!=$("textarea[name=command]").val()?M.checkEnvelopStatus():e.removeClass("disabled"))}),$(".pop-btn-open").click(function(){var e=M.walletAddr,a=$(".snatch textarea[name=command]").val(),t=$(this);if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);t.addClass("disabled"),t.addClass("anim"),param={word:a,receiver:e,userid:M.UserId,username:M.UserName,avatar:M.Avatar};var n=M.encodeParam(JSON.stringify(param));$.ajax({type:"POST",url:M.path+"/snatch",data:{data:n},dataType:"json",success:function(e){setTimeout(function(){t.removeClass("disabled"),0==e.ret?(M.jumpUrl("detail.html?word="+encodeURIComponent(a)),$("body").hasClass("chat")&&M.isInDapp()&&RedEnvelopeHost.onBackToRedEnvelope()):10004==e.ret?M.showToast(e.msg):10005==e.ret?($(".pop-envelope .view-detail").attr("url","detail.html?word="+encodeURIComponent(a)),$(".pop-envelope").addClass("late").show()):10003==e.ret?(M.jumpUrl("detail.html?word="+encodeURIComponent(a)),$("body").hasClass("chat")&&M.isInDapp()&&RedEnvelopeHost.onBackToRedEnvelope()):M.showToast(e.msg),t.removeClass("anim")},1200)}})}),$(".view-detail").click(function(){M.jumpUrl($(this).attr("url"))}),$("body").on("click",".record-list a",function(){M.jumpUrl($(this).attr("url"))}),$(".pop-close").click(function(){$("body").hasClass("chat")?M.isInDapp()&&RedEnvelopeHost.onBackToRedEnvelope():$(".pop-envelope").removeClass("late expire").hide()}),$("#iptCount").length>0&&document.getElementById("iptCount").addEventListener("input",function(t){var n=t.target.value,o=M.count,s="",r=!0;0==n?s="":n>o?s=M.lang[M.curLang].send.msg4+M.count+M.lang[M.curLang].send.countUnit:(s="",r=!1),e(s,r,$(this)),a(r)}),$("#iptMoney").length>0&&document.getElementById("iptMoney").addEventListener("input",function(t){var n=$(this).val(),o="",s=!1;0==n?(n="0.0000",s=!0):n>M.moneyMax?(o=M.lang[M.curLang].send.msg3+M.moneyMax+"ETH",s=!0):(n.indexOf("-")>-1||n.indexOf("+")>-1)&&(s=!0),$(".money .big").html(n),e(o,s,$(this)),a(s)}),$("#iptCommand").length>0&&document.getElementById("iptCommand").addEventListener("input",function(t){var n="";""==$(this).val()?isHasError=!0:$(this).val().length>20?(n=M.lang[M.curLang].send.msg7,isHasError=!0):$(this).val().length<6&&$(this).hasClass("hasClicked")?isHasError=!0:isHasError=!1,e(n,isHasError,$(this)),a(isHasError)}),$("body").hasClass("record")&&$(window).scroll(function(){M.scrollLoad()})},checkEnvelopStatus:function(){$(".loading").show();var e=$(".snatch textarea[name=command]").val(),a=$(".btn"),t=M.encodeParam(JSON.stringify({word:e,receiver:M.walletAddr,userid:M.UserId}));$.ajax({type:"POST",url:M.path+"/checkWord",data:{data:t},dataType:"json",success:function(t){a.removeClass("disabled"),$(".loading").hide(),$("body").hasClass("chat")?($(".pop-envelope .t .pop-word span").html(e),0==t.ret||(10004==t.ret?$(".pop-envelope").addClass("expire").show():10005==t.ret?($(".pop-envelope .view-detail").attr("url","detail.html?word="+encodeURIComponent(e)),$(".pop-envelope").addClass("late").show()):10003==t.ret?(M.jumpUrl("detail.html?word="+encodeURIComponent(e)),RedEnvelopeHost.onBackToRedEnvelope()):M.showToast(t.msg))):0==t.ret?($(".pop-envelope").show(),$(".pop-envelope .t  .pop-word span").html(e)):10008==t.ret?M.showToast(M.lang[M.curLang].snatch.msg4):10004==t.ret?(M.showToast(M.lang[M.curLang].snatch.msg3),$(".toast").find(".errTimes").html(t.data.already_input_times),$(".toast").find(".leftTimes").html(t.data.remain_times)):10005==t.ret?($(".pop-envelope .view-detail").attr("url","detail.html?word="+encodeURIComponent(e)),$(".pop-envelope").addClass("late").show()):10003==t.ret?M.jumpUrl("detail.html?word="+encodeURIComponent(e)):M.showToast(t.msg)}})},bottomDistance:function(){return Math.max(document.body.scrollHeight,document.body.offsetHeight)-(window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0)-(window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0)<20},scrollLoad:function(){M.bottomDistance()&&(M.isLoadingRecord||(M.isLoadingRecord=!0,M.getRecord(M.record.pagination.offset)))},showToast:function(e){""!=e&&null==M.timerToast&&($(".toast").html(e).show(),M.timerToast=setTimeout(function(){$(".toast").hide().html(""),clearTimeout(M.timerToast),M.timerToast=null},2e3))},sendToBehide:function(e){var a=M.encodeParam(JSON.stringify(e));$.ajax({type:"POST",url:M.path+"/send",data:{data:a},dataType:"json",success:function(a){if(0==a.ret){var t=1e3*a.data.expires_at;M.shareImg({count:e.count,money:e.value,word:e.word,time:t})}else M.showToast("send error")}})},sendEvent:function(e,a){$(".btn-send-envelution").click(function(){var e={},t=$(".send input[name=eth]").val(),n=$(".send textarea").val(),o=$(".send input[name=number]").val(),s={},r=$(this);if(""!=t&&""!=n&&""!=o)return n.length<6?($('input[name="command"]').parent().addClass("error"),$('input[name="command"]').addClass("hasClicked"),void M.showToast(M.lang[M.curLang].send.msg6)):M.isHasNetwork()?void(r.hasClass("disabled")||(r.addClass("disabled"),s={value:t,word:n,count:o},$.ajax({type:"POST",url:M.path+"/check",data:s,dataType:"json",success:function(s){if(0==s.ret){e={value:t,word:n,count:o,sender:a,gasCount:1,gasPrice:"0.0001"},"undefined"!=typeof web3?web3=new Web3(web3.currentProvider):web3=new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/metamask"));try{web3.eth.sendTransaction({from:M.walletAddr,to:"0x9264f90fc14af5e2335bb4be65a617467ecd2af7",value:web3.toWei(t+"","ether")},function(a,t){void 0!=t&&(e.guid=web3.sha3(M.walletAddr+(new Date).getTime()),e.transaction_id=t,e.sender=M.walletAddr,e.userid=M.UserId,e.username=M.UserName,e.avatar=M.Avatar,M.sendToBehide(e))})}catch(e){alert(e)}}else{var i=s.msg;10002==s.ret?i=M.lang[M.curLang].send.msg1:10003==s.ret&&(i=M.lang[M.curLang].send.msg2),M.showToast(i),r.removeClass("disabled")}},error:function(e){alert(e)}}))):void M.showToast(M.lang[M.curLang].other.noNetwork)})},sortList:function(e){return e.sort(function(e,a){return new Date(a.created_at)-new Date(e.created_at)}),e},getRecord:function(e){void 0==e&&(e=0);var a={offset:e,count:8,sender:M.walletAddr};0!=e&&$(".record-list").append('<div class="loading"><span></span></div>'),$.ajax({type:"get",url:M.path+"/list",data:a,dataType:"json",success:function(e){if(0==e.ret){var a=[],t="",n=0;if(e.data.length>0&&$("body").hasClass("index"))return void $(".tip-box").addClass("show");$(".loading").remove();M.sortList(e.data);$.each(e.data,function(e,o){13==o.status?t=M.lang[M.curLang].record.status3:12==o.status?t=M.lang[M.curLang].record.status2:11==o.status?t=M.lang[M.curLang].record.status1:10==o.status?t="打款中":9==o.status?t=M.lang[M.curLang].record.status4:0==o.status&&(t="无效"),n=new Date(1e3*o.created_at).toLocaleString(),a.push('<li><a href="javascript:void(0)" url="detail.html?guid='+o.guid+'"><span class="mny">'+M.lang[M.curLang].record.trstMny+'<i class="f-r">'+o.value+' ETH</i></span><span class="time">'+n+'</span><span class="status">'+t+"</span></a></li>")}),$(".record-list").append(a.join("")),M.record=e,e.pagination.hasMore?M.isLoadingRecord=!1:M.isLoadingRecord=!0}}})},getDetail:function(){var e={offset:0,count:50,word:M.getParameter("word",window.location.search),guid:M.getParameter("guid",window.location.search)};$.ajax({type:"POST",url:M.path+"/history",data:e,dataType:"json",success:function(e){if(0==e.ret)try{var a=[],t="",n="",o=0,s=e.data.info.userid,r=!1,i=!1,d=!1,l=e.data.info.count,c="",u="images/sendAdva.png";c=e.data.info.username,""==c&&(c=M.formatAddr(s)),u=e.data.info.avatar,$(".head .addr").html(c),$(".head .adva img").attr("src",u),M.UserId==s&&(r=!0),e.data.records.length==e.data.info.count&&(i=!0),$(".head .sub").html("“"+e.data.info.word+"”"),a.push("<dt>"+M.lang[M.curLang].detail.dt+"</dt>");var g="",p="",h="",m=0,v=0;$.each(e.data.records,function(s,i){t=1!=e.data.records.length&&i.best_luck?'<i class="icon-crown">'+M.lang[M.curLang].detail.lucky+"</i>":"",i.userid!=M.UserId?n="":(n='<i class="me">('+M.lang[M.curLang].detail.me+")</i>",d=!0),i.userid==M.UserId&&(r?$(".head .money .big").html(e.data.info.total_value):$(".head .money .big").html(i.value.toFixed(4))),o+=i.value,g=i.username,p=i.userid,h=i.avatar,""==g&&(g=M.formatAddr(i.receiver)),""==h&&(h="images/default.png"),v=new Date(1e3*i.created_at).toLocaleString(),a.push('<dd><img src="'+h+'"><div class="info"><div class="addr">'+n+g+'</div><div class="time">'+v+'</div></div><div class="money"><span>'+i.value.toFixed(4)+" ETH</span>"+t+"</div></dd>")}),$(".list").html(a.join("")),$(".list dt .curMoney").html(o.toFixed(4)),$(".list dt .curCount").html(e.data.records.length),$(".list dt .allCount").html(e.data.info.count),$(".list dt .allMoney").html(e.data.info.total_value),r?(m=6,$(".head .ttl").html(M.lang[M.curLang].detail.titleSend),$(".wrap").addClass("detail-sender")):(m=3,$(".head .ttl").html(M.lang[M.curLang].detail.title),$(".wrap").removeClass("detail-sender")),M.myInfoc.report({page:m,dappstore_red_packet_page_im:132}),(!r&&i&&!d||r)&&$(".head .money .big").html(e.data.info.total_value),i&&($(".btn-share").hide(),$(".bag-noreceive").hide()),d&&$(".head .des").show(),$(".btn-share").click(function(){M.shareImg({count:l,money:e.data.info.total_value,word:e.data.info.word,time:1e3*e.expires_at})})}catch(e){alert(e)}if(0==$(".list dd").length){$(".list-box").addClass("list-notransation");var f=0;$("dt").length>0&&(f=$(".list").height()),$(".no-transition").height($(window).height()-$(".head").height()-f),$(".no-transition").css("top",f).show()}else $(".no-transition").hide()}})},formatAddr:function(e){return e.substr(0,8)+"..."+e.substr(-8,8)},getParameter:function(e,a){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=a.substr(1).match(t);return null!=n?n[2]:null},initSend:function(){document.title=M.lang[M.curLang].send.title,$(".return-box .ttl").html(M.lang[M.curLang].send.title),$("#iptMoney").siblings(".ipt-l").html(M.lang[M.curLang].send.money),$("#iptMoney").parents("label").find(".ipt-tip").html(M.lang[M.curLang].send.countDes),$("#iptCount").siblings(".ipt-l").html(M.lang[M.curLang].send.count),$("#iptCount").siblings(".ipt-r").html(M.lang[M.curLang].send.countUnit),$("#iptCount").attr("placeholder",M.lang[M.curLang].send.countPlh),$("#iptCount").parents("label").find(".ipt-tip").html(M.lang[M.curLang].send.moneyDes),$("#iptCommand").attr("placeholder",M.lang[M.curLang].send.commandPlh),$("#iptCommand").parents("label").find(".ipt-tip").html(M.lang[M.curLang].send.commandDes),$(".btn-send-envelution").html(M.lang[M.curLang].send.btn),$(".after-tip").html(M.lang[M.curLang].send.tip);var e=M.getEvelopSource();1==e?($("#iptCount").val(1).removeClass("error"),$("body").addClass("chat")):2==e&&$("body").addClass("chat")},initIndex:function(){document.title=M.lang[M.curLang].index.title,$(".title").html(M.lang[M.curLang].index.title),$(".sub-des").html(M.lang[M.curLang].index.sub),$(".btn-snatch").html(M.lang[M.curLang].index.btn1),$(".btn-send").html(M.lang[M.curLang].index.btn2),$(".btn-generate").text(M.lang[M.curLang].index.share),$(".tip-try").html(M.lang[M.curLang].index.tryTip),$(".tip-record").html(M.lang[M.curLang].index.recordTip),$(".tip-share").html(M.lang[M.curLang].index.shareTip),$(".method-box .ttl").html(M.lang[M.curLang].index.cardTitle),$.each($(".method-box p"),function(e,a){$(a).html(M.lang[M.curLang].index["p"+(e+1)])})},initSnatch:function(){document.title=M.lang[M.curLang].snatch.title,$(".return-box .ttl").html(M.lang[M.curLang].snatch.title),$("label").html(M.lang[M.curLang].snatch.lable),$(".btn").html(M.lang[M.curLang].snatch.btn),$(".pop-t").html(M.lang[M.curLang].snatch.popTtl),$(".late-t").html(M.lang[M.curLang].snatch.late),$(".expire-t").html(M.lang[M.curLang].snatch.expire),$(".view-detail").text(M.lang[M.curLang].snatch.veiewDetail);var e="";try{e=M.getEnvelopWord()}catch(e){}""!=e&&($("#iptCommand").val(e).removeClass("error"),$(".pop-envelope").show(),M.checkEnvelopStatus(),$("body").addClass("chat"));var a=M.getEvelopSource();1==a?$("body").addClass("chat"):2==a&&$("body").addClass("chat")},initRecord:function(){document.title=M.lang[M.curLang].record.title,$(".return-box .ttl").html(M.lang[M.curLang].record.title)},initDetail:function(){document.title=M.lang[M.curLang].detail.title,$(".return-box .ttl").html(M.lang[M.curLang].detail.title),$(".head .des").html(M.lang[M.curLang].detail.des),$(".bag-noreceive ").html(M.lang[M.curLang].detail.btm1),$(".no-transition span").html(M.lang[M.curLang].detail.msg1)},init:function(){try{M.getWalletAddr(),M.isInIosDapp()&&(window.webkit.messageHandlers.netStatus.postMessage({indexName:"net"}),window.webkit.messageHandlers.phoneLanguage.postMessage({indexName:"lan"}),M.getIosUserInfo()),M.curLang=M.getLang(),M.UserId=M.getUserId(),M.UserName=M.getUserName(),M.Avatar=M.getAvatar(),M.myInfoc=M.getInfoc()}catch(e){}$.ajax({url:"js/lang.json",dataType:"json",success:function(e){M.lang=e;try{M.isInDapp()&&(M.curLang.indexOf("zh_CN")>-1?M.curLang="zh":M.curLang.indexOf("zh_TW")>-1||M.curLang.indexOf("zh_HK")>-1||M.curLang.indexOf("zh_MO")>-1?M.curLang="tw":M.curLang.indexOf("en")>-1&&(M.curLang="en")),M.isInIosDapp()&&("cn"==M.curLang?M.curLang="zh":"cns"==M.curLang?M.curLang="tw":(M.curLang.indexOf("en"),M.curLang="en"))}catch(e){}M.bind();var a=1;$("body").hasClass("send")?(a=4,$.ajax({type:"POST",url:M.path+"/info",data:{},dataType:"json",success:function(e){0==e.ret?(M.moneyMax=e.data.max,M.moneyMin=e.data.min,M.unit=e.data.unit,M.count=500,M.initSend(),$(".loading").hide(),$("body").removeClass("load"),M.sendEvent()):M.showToast("info error")}})):$("body").hasClass("record")?(a=5,M.initRecord(),M.getRecord()):$("body").hasClass("snatch")?(a=2,M.initSnatch()):$("body").hasClass("detail")?(M.initDetail(),M.getDetail()):$("body").hasClass("index")&&(a=1,M.initIndex(),M.getRecord()),$("body").hasClass("detail")||M.myInfoc.report({page:a,dappstore_red_packet_page_im:132})},error:function(e){}})}};$(function(){M.init()});