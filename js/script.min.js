function loading(){$("body").hasClass("chat")||$(".toast").html(M.lang[M.curLang].other.shareImg).show()}var M={walletAddr:"",contracts:{},path:"https://blockchain.ijinshan.com/redpacket",isLoadingRecord:!1,record:null,timerToast:null,curLang:"en",lang:{},iosNet:!1,isClose:!1,myInfoc:null,userInfo:null,isInDapp:function(){try{return 1==RedEnvelopeHost.isInDappAndroid()}catch(e){}},isInIosDapp:function(){return navigator.userAgent.indexOf("inIosDapp")>-1},iosNetStatus:function(e){M.iosNet=e},iosWalletAddress:function(e){M.walletAddr=e},getWalletAddr:function(){M.isInDapp()?(M.walletAddr=RedEnvelopeHost.getWalletAddress(),$("html").addClass("android")):M.isInIosDapp()&&($("body").hasClass("index")?window.webkit.messageHandlers.h5Callback.postMessage({indexName:"address"}):window.webkit.messageHandlers.sofaWalletAddress.postMessage({indexName:"address"}),$("html").addClass("ios"))},getInfoc:function(){var e=navigator.userAgent,t=e.split("$&*")[1];void 0!=t&&(t=t.split(";")[0].replace(/:/g,"=").replace(/\//g,"&")),t="?"+t;var a={ver:M.getParameter("ver",t),mcc:M.getParameter("mcc",t),cn:M.getParameter("cn",t),xaid:M.getParameter("xaid",t),osver:M.getParameter("osver",t),mnc:0,cl:navigator.language||navigator.browserLanguage,cn2:"",loc_time:1,brand:"",model:"",romver:"",adid:"",apilevel:23};return new Infoc("https://helpdappstore1.ksmobile.com",a)},getIosUserInfo:function(){try{var e={type:"SJbridge",functionName:"currentUserInfo"};M.userInfo=JSON.parse(prompt(JSON.stringify(e)))}catch(e){}},getUserId:function(){return M.isInDapp()?RedEnvelopeHost.getUserId():M.isInIosDapp()?M.userInfo.userid:""},closeCurrentActivity:function(){if(M.isInDapp())RedEnvelopeHost.onBackToRedEnvelope();else if(M.isInIosDapp())try{if(M.isClose)var e="closeSnatchView";else e="removeSnatchView";var t={type:"SJbridge",functionName:e};prompt(JSON.stringify(t))}catch(e){}},getUserName:function(){return M.isInDapp()?RedEnvelopeHost.getUserName():M.isInIosDapp()?M.userInfo.name:""},getAvatar:function(){return M.isInDapp()?RedEnvelopeHost.getAvatarUrl():M.isInIosDapp()?M.userInfo.avatar:""},getEnvelopWord:function(){return M.isInDapp()?RedEnvelopeHost.getRedPacketPwd():M.isInIosDapp()?M.userInfo.password:""},isDownload:function(){if(!M.isInDapp()&&!M.isInIosDapp()){var e='<div class="dialog"><div class="title">'+M.lang[M.curLang].other.downloadTitle+'</div><div class="cnt">'+M.lang[M.curLang].other.downloadCnt+'</div><a href="https://www.cmcmbc.com/zh-cn/dapp-browser/" class="d-btn btn-ok">'+M.lang[M.curLang].other.btnOk+'</a><a href="javascript:void(0);" class="d-btn btn-cancel">'+M.lang[M.curLang].other.btnCancel+"</a></div>";$("body").append(e),M.myInfoc.report({page:7,dappstore_red_packet_page_im:132})}},jumpUrl:function(e){if(M.isInDapp())if(e.indexOf("back")>-1)RedEnvelopeHost.onBackToRedEnvelope();else{if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);RedEnvelopeHost.jumpToEnvelope(e)}else if(M.isInIosDapp())if("back"==e)window.webkit.messageHandlers.sofaH5Callback.postMessage({indexName:e});else{if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);window.webkit.messageHandlers.h5Callback.postMessage({indexName:e})}},shareImg:function(e){if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);M.isInDapp()?""!=e?RedEnvelopeHost.createEnvelopeShare(JSON.stringify(e)):RedEnvelopeHost.createEnvelopeShare(""):M.isInIosDapp()&&(""!=e?window.webkit.messageHandlers.shareHongbao.postMessage({hongbaoCount:e.count,ethCount:e.money,word:e.word,invalidTime:e.time}):window.webkit.messageHandlers.h5Callback.postMessage({indexName:"share"}))},getEvelopSource:function(){try{if(M.isInDapp())return RedEnvelopeHost.getRedPacketSource();if(!M.isInIosDapp())return 0;try{var e={type:"SJbridge",functionName:"getRedPacketSource"};return prompt(JSON.stringify(e)).fromIndex}catch(e){}}catch(e){}},iosPhoneLanguage:function(e){M.curLang=e},getLang:function(){return M.isInDapp()?RedEnvelopeHost.getMobileLanguage():M.isInIosDapp()?M.curLang:"zh"},isHasNetwork:function(){return M.isInDapp()?RedEnvelopeHost.isMobileNetAvailable():!M.isInIosDapp()||M.iosNet},encodeParam:function(e){if(M.isInDapp())return RedEnvelopeHost.encryptBody(e);if(M.isInIosDapp())try{var t={type:"SJbridge",functionName:"AESEncode",data:e};return prompt(JSON.stringify(t))}catch(e){}return e},bind:function(){function e(e,t,a){""!=e&&(M.showToast(e),$(".btn").addClass("disabled")),t?(a.addClass("error"),a.parent().addClass("error")):(a.removeClass("error"),a.parent().removeClass("error"))}function t(e){e?$(".btn").addClass("disabled"):0==$("input.error").length&&0==$("textarea.error").length&&$(".btn").removeClass("disabled")}function a(e,t){if(e||t.hasClass("error"))$(".gas span").html("0.000000 ETH");else{var a=$(".send input[name=eth]").val(),n=$(".send input[name=number]").val(),s={value:a,count:n};$.ajax({type:"POST",url:M.path+"/check",data:s,dataType:"json",success:function(e){if(console.log(e),10001==e.ret){var t=e.data.estimateGas+"";t=t.substring(0,t.indexOf(".")+7),$(".gas span").html(t+" ETH")}},error:function(e){alert(e)}})}}$("html").on("click",".dialog .btn-cancel",function(){$(".dialog").hide()}),$("body").on("click",".btn-ok",function(){}),$(".btn-send").click(function(){M.isDownload(),M.jumpUrl("send.html")}),$(".btn-snatch").click(function(){M.isDownload(),M.jumpUrl("snatch.html")}),$(".tip-record").click(function(){M.isDownload(),M.jumpUrl("record.html")}),$(".btn-generate").click(function(){M.isDownload(),M.shareImg("")}),$(".btn-return").click(function(){M.jumpUrl("back")}),$(".btn-confirm-pw").click(function(){var e=$(this);if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);e.hasClass("disabled")||(e.addClass("disabled"),$("textarea[name=command]").val().length<6?($("#iptCommand").addClass("hasClicked error"),M.showToast(M.lang[M.curLang].send.msg6)):""!=$("textarea[name=command]").val()?M.checkEnvelopStatus():e.removeClass("disabled"))}),$(".pop-btn-open").click(function(){var e=M.walletAddr,t=$(".snatch textarea[name=command]").val(),a=$(this);if(!M.isHasNetwork())return void M.showToast(M.lang[M.curLang].other.noNetwork);a.addClass("disabled"),a.addClass("anim"),param={word:t,receiver:e,userid:M.UserId,username:M.UserName,avatar:M.Avatar};var n=M.encodeParam(JSON.stringify(param));$.ajax({type:"POST",url:M.path+"/snatch",data:{data:n},dataType:"json",success:function(e){setTimeout(function(){a.removeClass("disabled"),0==e.ret?(M.jumpUrl("detail.html?word="+encodeURIComponent(t)),$("body").hasClass("chat")&&(M.isClose=!1,M.closeCurrentActivity())):10004==e.ret?M.showToast(e.msg):10005==e.ret?($(".pop-envelope .view-detail").attr("url","detail.html?word="+encodeURIComponent(t)),$(".pop-envelope").addClass("late").show()):10003==e.ret?(M.jumpUrl("detail.html?word="+encodeURIComponent(t)),$("body").hasClass("chat")&&(M.isClose=!1,M.closeCurrentActivity())):M.showToast(e.msg),a.removeClass("anim")},1200)}})}),$(".view-detail").click(function(){M.jumpUrl($(this).attr("url"))}),$("body").on("click",".record-list a",function(){M.jumpUrl($(this).attr("url"))}),$(".pop-close").click(function(){$("body").hasClass("chat")?(M.isClose=!0,M.closeCurrentActivity()):$(".pop-envelope").removeClass("late expire").hide()}),$("#iptCount").length>0&&document.getElementById("iptCount").addEventListener("input",function(n){var s=n.target.value,o=M.count,r="",i=!0;0==s?r="":s>o?r=M.lang[M.curLang].send.msg4+M.count+M.lang[M.curLang].send.countUnit:(r="",i=!1),e(r,i,$(this)),t(i),a(i,$("#iptMoney"))}),$("#iptMoney").length>0&&document.getElementById("iptMoney").addEventListener("input",function(n){var s=$(this).val(),o="",r=!1;0==s?(s="0.0000",r=!0):s>M.moneyMax?(o=M.lang[M.curLang].send.msg3+M.moneyMax+"ETH",r=!0):(s.indexOf("-")>-1||s.indexOf("+")>-1)&&(r=!0),$(".money .big").html(s),e(o,r,$(this)),t(r),a(r,$("#iptCount"))}),$("#iptCommand").length>0&&document.getElementById("iptCommand").addEventListener("input",function(a){var n="";""==$(this).val()?isHasError=!0:$(this).val().length>20?(n=M.lang[M.curLang].send.msg7,isHasError=!0):$(this).val().length<6&&$(this).hasClass("hasClicked")?isHasError=!0:isHasError=!1,e(n,isHasError,$(this)),t(isHasError)}),$("body").hasClass("record")&&$(window).scroll(function(){M.scrollLoad()})},checkEnvelopStatus:function(){$(".loading").show();var e=$(".snatch textarea[name=command]").val(),t=$(".btn"),a=M.encodeParam(JSON.stringify({word:e,receiver:M.walletAddr,userid:M.UserId}));$.ajax({type:"POST",url:M.path+"/checkWord",data:{data:a},dataType:"json",success:function(a){t.removeClass("disabled"),$(".loading").hide(),$("body").hasClass("chat")?($(".pop-envelope .t .pop-word span").html(e),0==a.ret||(10004==a.ret?$(".pop-envelope").addClass("expire").show():10005==a.ret?($(".pop-envelope .view-detail").attr("url","detail.html?word="+encodeURIComponent(e)),$(".pop-envelope").addClass("late").show()):10003==a.ret?(M.jumpUrl("detail.html?word="+encodeURIComponent(e)),M.isClose=!1,M.closeCurrentActivity()):M.showToast(a.msg))):0==a.ret?($(".pop-envelope").show(),$(".pop-envelope .t  .pop-word span").html(e)):10008==a.ret?M.showToast(M.lang[M.curLang].snatch.msg4):10004==a.ret?(M.showToast(M.lang[M.curLang].snatch.msg3),$(".toast").find(".errTimes").html(a.data.already_input_times),$(".toast").find(".leftTimes").html(a.data.remain_times)):10005==a.ret?($(".pop-envelope .view-detail").attr("url","detail.html?word="+encodeURIComponent(e)),$(".pop-envelope").addClass("late").show()):10003==a.ret?M.jumpUrl("detail.html?word="+encodeURIComponent(e)):M.showToast(a.msg)}})},bottomDistance:function(){return Math.max(document.body.scrollHeight,document.body.offsetHeight)-(window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0)-(window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0)<20},scrollLoad:function(){M.bottomDistance()&&(M.isLoadingRecord||(M.isLoadingRecord=!0,M.getRecord(M.record.pagination.offset)))},showToast:function(e){""!=e&&null==M.timerToast&&($(".toast").html(e).show(),M.timerToast=setTimeout(function(){$(".toast").hide().html(""),clearTimeout(M.timerToast),M.timerToast=null},2e3))},sendToBehide:function(e){var t=M.encodeParam(JSON.stringify(e));$.ajax({type:"POST",url:M.path+"/send",data:{data:t},dataType:"json",success:function(t){if(0==t.ret){var a=1e3*t.data.expires_at;M.shareImg({count:e.count,money:e.value,word:e.word,time:a})}else M.showToast("send error")}})},sendEvent:function(e,t){$(".btn-send-envelution").click(function(){var e={},a=$(".send input[name=eth]").val(),n=$(".send textarea").val(),s=$(".send input[name=number]").val(),o={},r=$(this);if(""!=a&&""!=n&&""!=s)return n.length<6?($('input[name="command"]').parent().addClass("error"),$('input[name="command"]').addClass("hasClicked"),void M.showToast(M.lang[M.curLang].send.msg6)):M.isHasNetwork()?void(r.hasClass("disabled")||(r.addClass("disabled"),o={value:a,word:n,count:s},$.ajax({type:"POST",url:M.path+"/check",data:o,dataType:"json",success:function(o){if(0==o.ret){e={value:a,word:n,count:s,sender:t,gasCount:1,gasPrice:"0.0001"},"undefined"!=typeof web3?web3=new Web3(web3.currentProvider):web3=new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/metamask"));try{web3.eth.sendTransaction({from:M.walletAddr,to:"0x9264f90fc14af5e2335bb4be65a617467ecd2af7",value:web3.toWei(a+"","ether")},function(t,a){void 0!=a&&(e.guid=web3.sha3(M.walletAddr+(new Date).getTime()),e.transaction_id=a,e.sender=M.walletAddr,e.userid=M.UserId,e.username=M.UserName,e.avatar=M.Avatar,M.sendToBehide(e))})}catch(e){alert(e)}}else{var i=o.msg;10002==o.ret?i=M.lang[M.curLang].send.msg1:10003==o.ret&&(i=M.lang[M.curLang].send.msg2),M.showToast(i),r.removeClass("disabled")}},error:function(e){alert(e)}}))):void M.showToast(M.lang[M.curLang].other.noNetwork)})},sortList:function(e){return e.sort(function(e,t){return new Date(t.created_at)-new Date(e.created_at)}),e},getRecord:function(e){void 0==e&&(e=0);var t={offset:e,count:8,sender:M.walletAddr};0!=e&&$(".record-list").append('<div class="loading"><span></span></div>'),$.ajax({type:"get",url:M.path+"/list",data:t,dataType:"json",success:function(e){if(0==e.ret){var t=[],a="",n=0;if(e.data.length>0&&$("body").hasClass("index"))return void $(".tip-box").addClass("show");$(".loading").remove();M.sortList(e.data);$.each(e.data,function(e,s){13==s.status?a=M.lang[M.curLang].record.status3:12==s.status?a=M.lang[M.curLang].record.status2:11==s.status?a=M.lang[M.curLang].record.status1:10==s.status?a="打款中":9==s.status?a=M.lang[M.curLang].record.status4:0==s.status&&(a="无效"),n=new Date(1e3*s.created_at).toLocaleString(),t.push('<li><a href="javascript:void(0)" url="detail.html?guid='+s.guid+'"><span class="mny">'+M.lang[M.curLang].record.trstMny+'<i class="f-r">'+s.value+' ETH</i></span><span class="time">'+n+'</span><span class="status">'+a+"</span></a></li>")}),$(".record-list").append(t.join("")),M.record=e,e.pagination.hasMore?M.isLoadingRecord=!1:M.isLoadingRecord=!0}}})},getDetail:function(){var e={offset:0,count:50,word:M.getParameter("word",window.location.search),guid:M.getParameter("guid",window.location.search)};$.ajax({type:"POST",url:M.path+"/history",data:e,dataType:"json",success:function(e){if(0==e.ret)try{var t=[],a="",n="",s=0,o=e.data.info.userid,r=!1,i=!1,d=!1,l=e.data.info.count,c="",u="images/sendAdva.png";c=e.data.info.username,""==c&&(c=M.formatAddr(o)),u=e.data.info.avatar,$(".head .addr").html(c),$(".head .adva img").attr("src",u),M.UserId==o&&(r=!0),e.data.records.length==e.data.info.count&&(i=!0),$(".head .sub").html("“"+e.data.info.word+"”"),t.push("<dt>"+M.lang[M.curLang].detail.dt+"</dt>");var g="",p="",m="",h=0,v=0;$.each(e.data.records,function(o,i){a=1!=e.data.records.length&&i.best_luck?'<i class="icon-crown">'+M.lang[M.curLang].detail.lucky+"</i>":"",i.userid!=M.UserId?n="":(n='<i class="me">('+M.lang[M.curLang].detail.me+")</i>",d=!0),i.userid==M.UserId&&(r?$(".head .money .big").html(e.data.info.total_value):$(".head .money .big").html(i.value.toFixed(4))),s+=i.value,g=i.username,p=i.userid,m=i.avatar,""==g&&(g=M.formatAddr(i.receiver)),""==m&&(m="images/default.png"),v=new Date(1e3*i.created_at).toLocaleString(),t.push('<dd><img src="'+m+'"><div class="info"><div class="addr">'+n+g+'</div><div class="time">'+v+'</div></div><div class="money"><span>'+i.value.toFixed(4)+" ETH</span>"+a+"</div></dd>")}),$(".list").html(t.join("")),$(".list dt .curMoney").html(s.toFixed(4)),$(".list dt .curCount").html(e.data.records.length),$(".list dt .allCount").html(e.data.info.count),$(".list dt .allMoney").html(e.data.info.total_value),r?(h=6,$(".head .ttl").html(M.lang[M.curLang].detail.titleSend),$(".wrap").addClass("detail-sender")):(h=3,$(".head .ttl").html(M.lang[M.curLang].detail.title),$(".wrap").removeClass("detail-sender")),M.myInfoc.report({page:h,dappstore_red_packet_page_im:132}),(!r&&i&&!d||r)&&$(".head .money .big").html(e.data.info.total_value),i&&($(".btn-share").hide(),$(".bag-noreceive").hide()),d&&$(".head .des").show(),$(".btn-share").click(function(){M.shareImg({count:l,money:e.data.info.total_value,word:e.data.info.word,time:1e3*e.data.info.expires_at})})}catch(e){alert(e)}if(0==$(".list dd").length){$(".list-box").addClass("list-notransation");var f=0;$("dt").length>0&&(f=$(".list").height()),$(".no-transition").height($(window).height()-$(".head").height()-f),$(".no-transition").css("top",f).show()}else $(".no-transition").hide()}})},formatAddr:function(e){return e.substr(0,8)+"..."+e.substr(-8,8)},getParameter:function(e,t){var a=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=t.substr(1).match(a);return null!=n?n[2]:null},initSend:function(){document.title=M.lang[M.curLang].send.title,$(".return-box .ttl").html(M.lang[M.curLang].send.title),$("#iptMoney").siblings(".ipt-l").html(M.lang[M.curLang].send.money),$("#iptMoney").parents("label").find(".ipt-tip").html(M.lang[M.curLang].send.countDes),$("#iptCount").siblings(".ipt-l").html(M.lang[M.curLang].send.count),$("#iptCount").siblings(".ipt-r").html(M.lang[M.curLang].send.countUnit),$("#iptCount").attr("placeholder",M.lang[M.curLang].send.countPlh),$("#iptCount").parents("label").find(".ipt-tip").html(M.lang[M.curLang].send.moneyDes),$("#iptCommand").attr("placeholder",M.lang[M.curLang].send.commandPlh),$("#iptCommand").parents("label").find(".ipt-tip").html(M.lang[M.curLang].send.commandDes),$(".btn-send-envelution").html(M.lang[M.curLang].send.btn),$(".after-tip").html(M.lang[M.curLang].send.tip),$(".gas").html(M.lang[M.curLang].send.msg9);var e=M.getEvelopSource();1==e?($("#iptCount").val(1).removeClass("error"),$("body").addClass("chat")):2==e&&$("body").addClass("chat")},initIndex:function(){document.title=M.lang[M.curLang].index.title,$(".title").html(M.lang[M.curLang].index.title),$(".sub-des").html(M.lang[M.curLang].index.sub),$(".btn-snatch").html(M.lang[M.curLang].index.btn1),$(".btn-send").html(M.lang[M.curLang].index.btn2),$(".btn-generate").text(M.lang[M.curLang].index.share),$(".tip-try").html(M.lang[M.curLang].index.tryTip),$(".tip-record").html(M.lang[M.curLang].index.recordTip),$(".tip-share").html(M.lang[M.curLang].index.shareTip),$(".method-box .ttl").html(M.lang[M.curLang].index.cardTitle),$.each($(".method-box p"),function(e,t){$(t).html(M.lang[M.curLang].index["p"+(e+1)])})},initSnatch:function(){document.title=M.lang[M.curLang].snatch.title,$(".return-box .ttl").html(M.lang[M.curLang].snatch.title),$("label").html(M.lang[M.curLang].snatch.lable),$(".btn").html(M.lang[M.curLang].snatch.btn),$(".pop-t").html(M.lang[M.curLang].snatch.popTtl),$(".late-t").html(M.lang[M.curLang].snatch.late),$(".expire-t").html(M.lang[M.curLang].snatch.expire),$(".view-detail").text(M.lang[M.curLang].snatch.veiewDetail);var e="";try{e=M.getEnvelopWord()}catch(e){}""!=e&&($("#iptCommand").val(e).removeClass("error"),$(".pop-envelope").show(),M.checkEnvelopStatus(),$("body").addClass("chat"));var t=M.getEvelopSource();1==t?$("body").addClass("chat"):2==t&&$("body").addClass("chat")},initRecord:function(){document.title=M.lang[M.curLang].record.title,$(".return-box .ttl").html(M.lang[M.curLang].record.title)},initDetail:function(){document.title=M.lang[M.curLang].detail.title,$(".return-box .ttl").html(M.lang[M.curLang].detail.title),$(".head .des").html(M.lang[M.curLang].detail.des),$(".bag-noreceive ").html(M.lang[M.curLang].detail.btm1),$(".no-transition span").html(M.lang[M.curLang].detail.msg1)},init:function(){try{M.getWalletAddr(),M.isInIosDapp()&&(window.webkit.messageHandlers.netStatus.postMessage({indexName:"net"}),window.webkit.messageHandlers.phoneLanguage.postMessage({indexName:"lan"}),M.getIosUserInfo()),M.curLang=M.getLang(),M.UserId=M.getUserId(),M.UserName=M.getUserName(),M.Avatar=M.getAvatar(),M.myInfoc=M.getInfoc()}catch(e){}$.ajax({url:"js/lang.json",dataType:"json",success:function(e){M.lang=e;try{M.isInDapp()&&(M.curLang.indexOf("zh_CN")>-1?M.curLang="zh":M.curLang.indexOf("zh_TW")>-1||M.curLang.indexOf("zh_HK")>-1||M.curLang.indexOf("zh_MO")>-1?M.curLang="tw":M.curLang.indexOf("en")>-1&&(M.curLang="en")),M.isInIosDapp()&&("cn"==M.curLang?M.curLang="zh":"cns"==M.curLang?M.curLang="tw":(M.curLang.indexOf("en"),M.curLang="en"))}catch(e){}M.bind();var t=1;$("body").hasClass("send")?(t=4,$.ajax({type:"POST",url:M.path+"/info",data:{},dataType:"json",success:function(e){0==e.ret?(M.moneyMax=e.data.max,M.moneyMin=e.data.min,M.unit=e.data.unit,M.count=e.data.maxCount,M.initSend(),$(".loading").hide(),$("body").removeClass("load"),M.sendEvent()):M.showToast("info error")}})):$("body").hasClass("record")?(t=5,M.initRecord(),M.getRecord()):$("body").hasClass("snatch")?(t=2,M.initSnatch()):$("body").hasClass("detail")?(M.initDetail(),M.getDetail()):$("body").hasClass("index")&&(t=1,M.initIndex(),M.getRecord()),$("body").hasClass("detail")||M.myInfoc.report({page:t,dappstore_red_packet_page_im:132})},error:function(e){}})}};$(function(){M.init()});